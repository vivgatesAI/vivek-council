<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ app_name }}</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="app">
        <header class="header">
            <div class="header-content">
                <div class="logo">
                    <svg width="32" height="32" viewBox="0 0 32 32" fill="none">
                        <rect width="32" height="32" rx="8" fill="url(#gradient)"/>
                        <path d="M8 12h16M8 16h12M8 20h14" stroke="white" stroke-width="2" stroke-linecap="round"/>
                        <defs>
                            <linearGradient id="gradient" x1="0" y1="0" x2="32" y2="32">
                                <stop stop-color="#6366f1"/>
                                <stop offset="1" stop-color="#8b5cf6"/>
                            </linearGradient>
                        </defs>
                    </svg>
                    <span class="logo-text">{{ app_name }}</span>
                </div>
                <div class="header-actions">
                    <a href="/about" class="about-link" title="Learn how it works">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <path d="M12 16v-4M12 8h.01"/>
                        </svg>
                    </a>
                    <div class="header-badge">
                        <span class="pulse"></span>
                        Powered by Venice AI
                    </div>
                </div>
            </div>
        </header>

        <main class="main">
            <div class="council-config">
                <div class="config-section">
                    <h3>Council Members</h3>
                    <div class="model-chips" id="modelChips">
                        {% for model in model_names %}
                        <span class="chip" data-model-name="{{ model }}">{{ model }}</span>
                        {% endfor %}
                    </div>
                </div>
                <div class="config-section">
                    <h3>Chairman</h3>
                    <div class="chairman-badge">{{ models|length + 1 }} model council</div>
                </div>
            </div>

            <section class="analysis-deck" id="analysisDeck">
                <div class="analysis-topbar">
                    <div class="stage-track" id="stageTrack">
                        <div class="stage-pill active" data-stage="opinions">1 ¬∑ Opinions</div>
                        <div class="stage-pill" data-stage="review">2 ¬∑ Cross-review</div>
                        <div class="stage-pill" data-stage="final">3 ¬∑ Final synthesis</div>
                    </div>
                    <button class="analysis-toggle" id="analysisToggle" type="button" aria-expanded="true" aria-controls="analysisDetails">Hide details</button>
                </div>
                <div class="analysis-details" id="analysisDetails">
                    <div class="analysis-summary">
                        <div class="analysis-focus" id="analysisFocus">Ready for your question.</div>
                        <div class="analysis-subtext" id="analysisSubtext">The council will reason step-by-step and show live progress.</div>
                    </div>
                    <div class="analysis-feed" id="analysisFeed">
                        <div class="feed-empty">Live council events will appear here.</div>
                    </div>
                </div>
            </section>

            <div class="chat-container" id="chatContainer">
                <div class="welcome-message" id="welcomeMessage">
                    <div class="welcome-icon">üèõÔ∏è</div>
                    <h2>Welcome to the Council</h2>
                    <p>Ask your question and multiple AI models will collaborate to provide the best answer.</p>
                    <div class="features">
                        <div class="feature"><span class="feature-icon">üí≠</span><span>First Opinions</span></div>
                        <div class="feature"><span class="feature-icon">üîç</span><span>Cross Review</span></div>
                        <div class="feature"><span class="feature-icon">‚ú®</span><span>Final Synthesis</span></div>
                    </div>
                </div>

                <div class="messages" id="messages"></div>
            </div>

            <div class="input-container">
                <div class="input-wrapper">
                    <textarea id="queryInput" placeholder="Ask your question to the council..." rows="1" autocomplete="off"></textarea>
                    <button id="sendButton" class="send-button" aria-label="Send question">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
                        </svg>
                    </button>
                </div>
                <div class="export-row">
                    <button id="downloadButton" class="download-button" disabled>Download Executive Brief (.html)</button>
                </div>
                <div class="progress-bar" id="progressBar" style="display: none;">
                    <div class="model-interaction" id="modelInteraction"></div>
                    <div class="progress-fill" id="progressFill"></div>
                    <span class="progress-text" id="progressText">Processing...</span>
                    <span class="timer" id="timer">00:00</span>
                </div>
                <div class="visual-status" id="visualStatus"></div>
            </div>
        </main>

        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header"><h3>Council Tabs</h3></div>
            <div class="tabs" id="tabs">
                <button class="tab active" data-tab="final"><span class="tab-icon">üèÜ</span>Final Answer</button>
                {% for model in model_names %}
                <button class="tab" data-tab="{{ loop.index0 }}"><span class="tab-icon">ü§ñ</span>{{ model }}</button>
                {% endfor %}
                <button class="tab" data-tab="reviews"><span class="tab-icon">üìã</span>Reviews</button>
            </div>
        </aside>
    </div>

    <script>
        const councilModels = {{ model_names|tojson }};
        const state = {
            messages: [], opinions: [], reviews: [], finalResponse: '', currentTab: 'final',
            isProcessing: false, activeModel: '', stage: 'idle', streamBuffer: '', currentQuestion: ''
        };

        const queryInput = document.getElementById('queryInput');
        const sendButton = document.getElementById('sendButton');
        const messagesContainer = document.getElementById('messages');
        const progressBar = document.getElementById('progressBar');
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        const welcomeMessage = document.getElementById('welcomeMessage');
        const tabsContainer = document.getElementById('tabs');
        const visualStatus = document.getElementById('visualStatus');
        const modelInteraction = document.getElementById('modelInteraction');
        const downloadButton = document.getElementById('downloadButton');
        const stageTrack = document.getElementById('stageTrack');
        const analysisFocus = document.getElementById('analysisFocus');
        const analysisSubtext = document.getElementById('analysisSubtext');
        const analysisFeed = document.getElementById('analysisFeed');
        const modelChips = document.getElementById('modelChips');
        const analysisDeck = document.getElementById('analysisDeck');
        const analysisToggle = document.getElementById('analysisToggle');
        const analysisDetails = document.getElementById('analysisDetails');

        function normalizeModelName(name) {
            return String(name || '').toLowerCase().replace(/[^a-z0-9]/g, '');
        }

        function findModelIndex(modelName) {
            const incoming = normalizeModelName(modelName);
            if (!incoming) return -1;
            return councilModels.findIndex(name => normalizeModelName(name) === incoming);
        }

        function upsertOpinion(opinion) {
            if (!opinion) return;
            const opinionIndex = findModelIndex(opinion.model_name);
            if (opinionIndex === -1) {
                state.opinions.push(opinion);
                return;
            }
            state.opinions[opinionIndex] = opinion;
        }

        function resetAnalysisState() {
            analysisFocus.textContent = 'Ready for your question.';
            analysisSubtext.textContent = 'The council will reason step-by-step and show live progress.';
            analysisFeed.innerHTML = '<div class="feed-empty">Live council events will appear here.</div>';
            stageTrack.querySelectorAll('.stage-pill').forEach((pill, idx) => {
                pill.classList.toggle('active', idx === 0);
                pill.classList.remove('done');
            });
            modelChips.querySelectorAll('.chip').forEach(chip => chip.classList.remove('active'));
        }

        function updateStage(stage, message, currentModel) {
            const stages = ['opinions', 'review', 'final', 'complete'];
            const stageIndex = stages.indexOf(stage || 'opinions');
            stageTrack.querySelectorAll('.stage-pill').forEach((pill, idx) => {
                const isDone = stageIndex > idx || stage === 'complete';
                const isActive = stageIndex === idx && stage !== 'complete';
                pill.classList.toggle('done', isDone);
                pill.classList.toggle('active', isActive);
            });

            if (stage === 'complete') {
                analysisFocus.textContent = 'Council synthesis complete.';
                analysisSubtext.textContent = 'Final answer is ready. Review each member tab for details.';
                return;
            }

            if (currentModel) {
                analysisFocus.textContent = `${currentModel} is active`;
            } else if (stage === 'opinions') {
                analysisFocus.textContent = 'Gathering first opinions';
            } else if (stage === 'review') {
                analysisFocus.textContent = 'Running cross-review';
            } else if (stage === 'final') {
                analysisFocus.textContent = 'Synthesizing final answer';
            }

            analysisSubtext.textContent = message || getStageText(stage, 0);
        }

        function addFeedItem(message, stage = 'opinions') {
            if (!message) return;
            const iconByStage = { opinions: 'üí≠', review: 'üîÑ', final: '‚ú®', complete: '‚úÖ' };
            const now = new Date();
            const stamp = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}:${String(now.getSeconds()).padStart(2, '0')}`;
            const item = document.createElement('div');
            item.className = 'feed-item';
            item.innerHTML = `<span class="feed-icon">${iconByStage[stage] || '‚Ä¢'}</span><span class="feed-text">${formatContent(message)}</span><span class="feed-time">${stamp}</span>`;

            if (analysisFeed.querySelector('.feed-empty')) {
                analysisFeed.innerHTML = '';
            }
            analysisFeed.prepend(item);
            const maxItems = 7;
            while (analysisFeed.children.length > maxItems) {
                analysisFeed.removeChild(analysisFeed.lastElementChild);
            }
        }

        function setActiveChip(modelName, isActive) {
            const modelIndex = findModelIndex(modelName);
            modelChips.querySelectorAll('.chip').forEach((chip, idx) => {
                if (isActive) {
                    chip.classList.toggle('active', idx === modelIndex);
                } else if (idx === modelIndex) {
                    chip.classList.remove('active');
                }
            });
        }

        function setAnalysisCollapsed(collapsed) {
            analysisDeck.classList.toggle('collapsed', collapsed);
            analysisToggle.textContent = collapsed ? 'Show details' : 'Hide details';
            analysisToggle.setAttribute('aria-expanded', String(!collapsed));
            analysisDetails.setAttribute('aria-hidden', String(collapsed));
        }

        function initializeVisuals() {
            modelInteraction.innerHTML = councilModels.map((name, idx) => `<div class="model-dot" data-model="${idx}" title="${name}">‚óè</div>`).join('') + '<div class="interaction-line"></div>';
            visualStatus.innerHTML = councilModels.map((name, idx) => `
                <div class="status-card" id="status-${idx}">
                    <div class="status-name">${name}</div>
                    <div class="status-pill">Waiting</div>
                </div>`).join('');
        }

        queryInput.addEventListener('input', () => {
            queryInput.style.height = 'auto';
            queryInput.style.height = Math.min(queryInput.scrollHeight, 150) + 'px';
        });
        queryInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendQuery(); }
        });
        sendButton.addEventListener('click', sendQuery);
        downloadButton.addEventListener('click', downloadReport);
        analysisToggle.addEventListener('click', () => {
            const shouldCollapse = !analysisDeck.classList.contains('collapsed');
            setAnalysisCollapsed(shouldCollapse);
        });
        setAnalysisCollapsed(false);

        let timerInterval = null;
        function startTimer() {
            const startTime = Date.now();
            timerInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                document.getElementById('timer').textContent = `${String(Math.floor(elapsed / 60)).padStart(2, '0')}:${String(elapsed % 60).padStart(2, '0')}`;
            }, 1000);
        }
        function stopTimer() { if (timerInterval) clearInterval(timerInterval); timerInterval = null; }

        function setModelStatus(modelName, text, isActive = false) {
            const idx = findModelIndex(modelName);
            if (idx === -1) return;
            const card = document.getElementById(`status-${idx}`);
            if (!card) return;
            card.querySelector('.status-pill').textContent = text;
            card.classList.toggle('active', isActive);
            document.querySelectorAll('.model-dot').forEach((dot, dotIdx) => {
                dot.classList.toggle('active', dotIdx === idx && isActive);
                if (text === 'Done' && dotIdx === idx) dot.classList.add('done');
            });
        }

        async function sendQuery() {
            const message = queryInput.value.trim();
            if (!message || state.isProcessing) return;

            state.isProcessing = true;
            state.opinions = Array(councilModels.length).fill(null);
            state.reviews = [];
            state.finalResponse = '';
            state.currentQuestion = message;
            queryInput.value = '';
            downloadButton.disabled = true;
            queryInput.disabled = true;
            sendButton.disabled = true;
            welcomeMessage.style.display = 'none';
            resetAnalysisState();
            progressBar.style.display = 'flex';
            visualStatus.style.display = 'grid';
            initializeVisuals();
            startTimer();

            addMessage('user', message);

            try {
                const response = await fetch('/api/council/stream', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message })
                });

                if (!response.ok || !response.body) {
                    throw new Error(`Request failed (${response.status})`);
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    buffer += decoder.decode(value, { stream: true });
                    const events = buffer.split('\n\n');
                    buffer = events.pop() || '';

                    for (const event of events) {
                        if (!event.startsWith('data: ')) continue;
                        const payload = event.slice(6).trim();
                        if (!payload) continue;
                        try {
                            const data = JSON.parse(payload);
                            handleStreamEvent(data);
                        } catch (e) {
                            console.error('SSE parse error', e, payload);
                        }
                    }
                }
            } catch (error) {
                addMessage('error', 'Failed to connect to council: ' + error.message);
            } finally {
                state.isProcessing = false;
                queryInput.disabled = false;
                sendButton.disabled = false;
                stopTimer();
                progressText.textContent = 'Complete!';
                setTimeout(() => {
                    progressBar.style.display = 'none';
                    progressFill.style.width = '0%';
                    document.getElementById('timer').textContent = '00:00';
                }, 1500);
                queryInput.focus();
            }
        }

        function handleStreamEvent(data) {
            if (data.error) {
                addMessage('error', data.error || data.message || 'Unknown stream error');
                return;
            }

            if (data.progress !== undefined) {
                progressFill.style.width = data.progress + '%';
                progressText.textContent = data.message || getStageText(data.stage, data.progress);
            }

            if (data.stage) {
                updateStage(data.stage, data.message, data.current_model);
            }
            if (data.message) {
                addFeedItem(data.message, data.stage);
            }

            if (data.current_model && data.message) {
                const active = !data.message.toLowerCase().includes('completed') && !data.message.toLowerCase().includes('submitted') && !data.message.toLowerCase().includes('synthesized');
                setModelStatus(data.current_model, active ? 'Working' : 'Done', active);
                setActiveChip(data.current_model, active);
            }

            if (data.opinion) {
                upsertOpinion(data.opinion);
                displayResults();
            }
            if (data.review) state.reviews.push(data.review);

            if (data.final_chunk) {
                state.finalResponse += data.final_chunk;
                renderStreamingFinal();
            }

            if (data.final) {
                state.finalResponse = data.final;
                displayResults();
                downloadButton.disabled = false;
            }
        }

        function renderStreamingFinal() {
            let finalCard = document.getElementById('streamingFinalCard');
            if (!finalCard) {
                finalCard = document.createElement('div');
                finalCard.className = 'result-section final-result streaming';
                finalCard.id = 'streamingFinalCard';
                messagesContainer.innerHTML = '';
                messagesContainer.appendChild(finalCard);
            }
            finalCard.innerHTML = `
                <div class="result-header"><span class="result-badge">üèÜ</span><span>Chairman is writing...</span></div>
                <div class="result-content">${formatContent(state.finalResponse)}<span class="typing-cursor">‚ñå</span></div>
            `;
        }

        function getStageText(stage, progress) {
            if (progress < 30) return 'Getting first opinions...';
            if (progress < 60) return 'Cross-reviewing responses...';
            if (progress < 100) return 'Synthesizing final answer...';
            return 'Complete!';
        }

        function addMessage(role, content) {
            const div = document.createElement('div');
            div.className = `message message-${role}`;
            div.innerHTML = `<div class="message-avatar">${role === 'user' ? 'üë§' : 'üèõÔ∏è'}</div><div class="message-content"><div class="message-text">${formatContent(content)}</div></div>`;
            messagesContainer.appendChild(div);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function formatContent(content) {
            return String(content || '')
                .replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
                .replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>')
                .replace(/`([^`]+)`/g, '<code>$1</code>')
                .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
                .replace(/\n/g, '<br>');
        }

        function displayResults() {
            messagesContainer.innerHTML = '';
            if (state.finalResponse) {
                const finalDiv = document.createElement('div');
                finalDiv.className = 'result-section final-result';
                finalDiv.dataset.tab = 'final';
                finalDiv.style.display = state.currentTab === 'final' ? 'block' : 'none';
                finalDiv.innerHTML = `<div class="result-header"><span class="result-badge">üèÜ</span><span>Final Council Answer</span></div><div class="result-content">${formatContent(state.finalResponse)}</div>`;
                messagesContainer.appendChild(finalDiv);
            }

            councilModels.forEach((modelName, i) => {
                const opinion = state.opinions[i];
                const div = document.createElement('div');
                div.className = 'result-section opinion-result';
                div.dataset.tab = i;
                div.style.display = state.currentTab == i ? 'block' : 'none';
                if (opinion) {
                    div.innerHTML = `<div class="result-header"><span class="result-badge">ü§ñ</span><span>${opinion.model_name}</span></div><div class="result-content">${formatContent(opinion.content)}</div>`;
                } else {
                    div.innerHTML = `<div class="result-header"><span class="result-badge">ü§ñ</span><span>${modelName}</span></div><div class="result-content"><em>${state.isProcessing ? 'Waiting for this member to finish their draft‚Ä¶' : 'No response captured for this member in this run.'}</em></div>`;
                }
                messagesContainer.appendChild(div);
            });

            if (state.reviews.length > 0) {
                const reviewsDiv = document.createElement('div');
                reviewsDiv.className = 'result-section reviews-result';
                reviewsDiv.dataset.tab = 'reviews';
                reviewsDiv.style.display = state.currentTab === 'reviews' ? 'block' : 'none';
                reviewsDiv.innerHTML = `<div class="result-header"><span class="result-badge">üìã</span><span>Cross Reviews</span></div><div class="reviews-grid">${state.reviews.map(review => `<div class="review-card"><div class="review-header">${review.model_name}</div><div class="review-content">${formatContent(review.content)}</div></div>`).join('')}</div>`;
                messagesContainer.appendChild(reviewsDiv);
            }
        }


        function escapeHtml(value) {
            return String(value || '')
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;');
        }

        function markdownToBriefHtml(content) {
            const source = String(content || '').replace(/\r\n/g, '\n').trim();
            if (!source) return '<p>No content captured.</p>';

            const lines = source.split('\n');
            const blocks = [];
            let paragraph = [];
            let listItems = [];
            let listType = null;
            let inCodeBlock = false;
            let codeBuffer = [];

            const flushParagraph = () => {
                if (!paragraph.length) return;
                blocks.push(`<p>${paragraph.join(' ').trim()}</p>`);
                paragraph = [];
            };

            const flushList = () => {
                if (!listItems.length || !listType) return;
                blocks.push(`<${listType}>${listItems.map(item => `<li>${item}</li>`).join('')}</${listType}>`);
                listItems = [];
                listType = null;
            };

            const formatInline = (text) => {
                return escapeHtml(text)
                    .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*([^*]+)\*/g, '<em>$1</em>')
                    .replace(/`([^`]+)`/g, '<code>$1</code>')
                    .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>');
            };

            for (const rawLine of lines) {
                const line = rawLine.trim();

                if (line.startsWith('```')) {
                    flushParagraph();
                    flushList();
                    if (inCodeBlock) {
                        blocks.push(`<pre><code>${escapeHtml(codeBuffer.join('\n'))}</code></pre>`);
                        codeBuffer = [];
                        inCodeBlock = false;
                    } else {
                        inCodeBlock = true;
                    }
                    continue;
                }

                if (inCodeBlock) {
                    codeBuffer.push(rawLine);
                    continue;
                }

                if (!line) {
                    flushParagraph();
                    flushList();
                    continue;
                }

                if (/^---+$/.test(line) || /^\*\*\*+$/.test(line)) {
                    flushParagraph();
                    flushList();
                    blocks.push('<hr>');
                    continue;
                }

                const headingMatch = line.match(/^(#{1,4})\s+(.+)$/);
                if (headingMatch) {
                    flushParagraph();
                    flushList();
                    const level = Math.min(4, headingMatch[1].length);
                    blocks.push(`<h${level}>${formatInline(headingMatch[2])}</h${level}>`);
                    continue;
                }

                const orderedMatch = line.match(/^\d+\.\s+(.+)$/);
                if (orderedMatch) {
                    flushParagraph();
                    if (listType && listType !== 'ol') flushList();
                    listType = 'ol';
                    listItems.push(formatInline(orderedMatch[1]));
                    continue;
                }

                const bulletMatch = line.match(/^[-*]\s+(.+)$/);
                if (bulletMatch) {
                    flushParagraph();
                    if (listType && listType !== 'ul') flushList();
                    listType = 'ul';
                    listItems.push(formatInline(bulletMatch[1]));
                    continue;
                }

                flushList();
                paragraph.push(formatInline(line));
            }

            flushParagraph();
            flushList();

            if (inCodeBlock && codeBuffer.length) {
                blocks.push(`<pre><code>${escapeHtml(codeBuffer.join('\n'))}</code></pre>`);
            }

            return blocks.join('');
        }

        function reportSection(title, content, meta = '', tone = 'sun') {
            return `<section class="brief-card tone-${tone}"><h3>${escapeHtml(title)}</h3>${meta ? `<p class="brief-meta">${escapeHtml(meta)}</p>` : ''}<div class="brief-content">${markdownToBriefHtml(content)}</div></section>`;
        }

        function buildExecutiveBriefHtml() {
            const now = new Date();
            const finalSection = reportSection('Final Recommendation', state.finalResponse || 'No final response captured yet.', 'Chairman synthesis', 'teal');
            const opinions = state.opinions.map((op, idx) => reportSection(`Council Member ${idx + 1}: ${op.model_name}`, op.content, 'First opinions', idx % 2 === 0 ? 'sun' : 'cocoa')).join('');
            const reviews = state.reviews.map((rev, idx) => reportSection(`Review ${idx + 1}: ${rev.model_name}`, rev.content, 'Cross-review insight', idx % 2 === 0 ? 'olive' : 'teal')).join('');

            return `<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Vivek Council Executive Brief</title>
<style>
:root { --ink:#1f2937; --muted:#5b5564; --paper:#f6efe1; --sand:#e8dcc2; --sun:#f0a43a; --teal:#0f766e; --olive:#6b7c36; --cocoa:#6d4c41; --cream:#fffaf0; }
*{box-sizing:border-box}
body{margin:0;font-family:"Trebuchet MS","Avenir Next",Avenir,"Gill Sans",sans-serif;background:radial-gradient(circle at 20% 0%, #fff7e6 0%, #f1e6d0 40%, #e8dcc2 100%);color:var(--ink)}
.wrap{max-width:1080px;margin:0 auto;padding:34px 24px 80px;position:relative}
.wrap::before,.wrap::after{content:"";position:fixed;width:170px;height:170px;border-radius:50%;z-index:0;opacity:.18;pointer-events:none}
.wrap::before{top:40px;left:-55px;background:var(--sun)}
.wrap::after{bottom:30px;right:-40px;background:var(--teal)}
.hero{position:relative;z-index:1;background:linear-gradient(125deg,#0f766e 0%,#115e59 35%,#f0a43a 100%);color:#fff;border-radius:26px;padding:34px 38px;box-shadow:0 16px 0 rgba(31,41,55,.16),0 32px 55px rgba(15,23,42,.18);margin-bottom:28px;overflow:hidden}
.hero::after{content:"";position:absolute;inset:-30% auto auto 62%;width:260px;height:260px;border-radius:50%;background:rgba(255,250,240,.18)}
.hero h1{margin:0 0 14px;font-size:46px;line-height:1.1;letter-spacing:.02em;font-weight:800}
.hero .meta{font-size:24px;line-height:1.5;max-width:90%;position:relative;z-index:1}
.hero .meta strong{color:#fff7d6}
.grid{position:relative;z-index:1;display:grid;gap:16px}
.brief-card{border-radius:20px;padding:24px 24px 22px;border:2px solid rgba(31,41,55,.12);background:var(--cream);box-shadow:0 12px 24px rgba(31,41,55,.08)}
.brief-card h3{margin:0 0 6px;font-size:25px;letter-spacing:.015em}
.brief-meta{margin:0 0 12px;font-size:14px;text-transform:uppercase;letter-spacing:.08em;color:var(--muted);font-weight:700}
.tone-sun{border-left:12px solid var(--sun)} .tone-teal{border-left:12px solid var(--teal)} .tone-olive{border-left:12px solid var(--olive)} .tone-cocoa{border-left:12px solid var(--cocoa)}
.brief-content{font-size:18px;line-height:1.72}
.brief-content p{margin:0 0 14px}
.brief-content h1,.brief-content h2,.brief-content h3,.brief-content h4{margin:18px 0 10px;line-height:1.3;color:#111827}
.brief-content h1{font-size:34px}.brief-content h2{font-size:30px}.brief-content h3{font-size:25px}.brief-content h4{font-size:21px}
.brief-content ul,.brief-content ol{margin:0 0 14px 24px;padding:0}
.brief-content li{margin:5px 0}
.brief-content code{background:#efe4cd;padding:2px 6px;border-radius:6px;font-family:"JetBrains Mono",ui-monospace,monospace;font-size:.86em}
.brief-content pre{margin:0 0 14px;background:#1f2937;color:#f9fafb;padding:14px;border-radius:12px;overflow:auto}
.brief-content pre code{background:transparent;padding:0;color:inherit}
.brief-content hr{border:none;border-top:3px dashed rgba(31,41,55,.25);margin:18px 0}
.brief-content a{color:#0f766e;text-decoration:underline}
.section-title{position:relative;z-index:1;margin:28px 0 10px;font-size:13px;font-weight:800;letter-spacing:.16em;text-transform:uppercase;color:#374151}
.footer{position:relative;z-index:1;margin-top:30px;font-size:12px;letter-spacing:.06em;text-transform:uppercase;color:#6b7280;text-align:right}
@media (max-width: 720px){.hero h1{font-size:34px}.hero .meta{font-size:20px}.brief-content{font-size:16px}.brief-card h3{font-size:21px}}
</style>
</head>
<body>
<div class="wrap">
    <div class="hero">
        <h1>Vivek Council ‚Äî Executive Brief</h1>
        <div class="meta"><p><strong>Prompt:</strong> ${escapeHtml(state.currentQuestion || 'N/A')}</p><p><strong>Generated:</strong> ${escapeHtml(now.toLocaleString())}</p></div>
    </div>
    <div class="grid">${finalSection}</div>
    <div class="section-title">Council Member Perspectives</div>
    <div class="grid">${opinions || '<section class="brief-card tone-sun"><div class="brief-content"><p>No member opinions captured.</p></div></section>'}</div>
    <div class="section-title">Cross-Reviews</div>
    <div class="grid">${reviews || '<section class="brief-card tone-olive"><div class="brief-content"><p>No review content captured.</p></div></section>'}</div>
    <div class="footer">Prepared by Vivek Council</div>
</div>
</body>
</html>`;
        }

        function downloadReport() {
            const html = buildExecutiveBriefHtml();
            const blob = new Blob([html], { type: 'text/html;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const ts = new Date().toISOString().replace(/[:.]/g, '-');
            const a = document.createElement('a');
            a.href = url;
            a.download = `vivek-council-executive-brief-${ts}.html`;
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
        }

        tabsContainer.addEventListener('click', (e) => {
            const tab = e.target.closest('.tab');
            if (!tab) return;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            state.currentTab = tab.dataset.tab;
            displayResults();
        });

        initializeVisuals();
        queryInput.focus();
    </script>
</body>
</html>
